package com.brilliantblue.panasonic.IFEdemo.audioVideo.musicOnDemand.playListView{	import flash.display.*;	import flash.events.*;	import flash.net.URLRequest;	import flash.text.TextField;	import flash.text.TextFormat;	import flash.text.TextFieldAutoSize;	import flash.filters.GlowFilter;	import flash.filters.BitmapFilterQuality;	import flash.external.*;	import com.brilliantblue.panasonic.IFEdemo.view;	import com.brilliantblue.panasonic.IFEdemo.common.screen.*;	import com.brilliantblue.panasonic.IFEdemo.common.buttons.*;	import com.brilliantblue.panasonic.IFEdemo.common.key.*;		import caurina.transitions.Tweener;	import caurina.transitions.Equations;		import com.brilliantblue.panasonic.IFEdemo.audioVideo.musicOnDemand.view;		public class view extends com.brilliantblue.panasonic.IFEdemo.view	{						private var _imageLoader:Loader;		private var _extrasLoader:Loader;		public var _xmlData:XML;		private var _titleText:String;		private var _albums:XMLList;		private var _album:XMLList;		private var _tracks:XMLList;		private var _bodyText:String;		private var _artist:String;		private var _albumName:String;		private var _thumbsrc:String;		private var _price:String;		private var _musicThumb:MovieClip;		private var _musicExtras:MovieClip;		private var _backButton:MovieClip;		private var _playAlbumButton:MovieClip;		private var _allTracksButton:MovieClip;		private var _viewPlayListButton:MovieClip;		private var _playList:XML;		public var _trackID;		private var _currentTrack;		private var _playAll:Boolean;		private var _mediaPlaying:Boolean;						public function view () {			//_itemID = "movie.001";//test ID			//////////set up page//////////						setLayout("2column");			setScreenTitle("playlist");			adjustScreen();									//////////add buttons//////////										_backButton = new BasicButton();			_backButton.setTitle("back");			_backButton.XPos = "LEFT";			_backButton.setClickEvent(goBack);			//_playAlbumButton.y = 606			_backButton.name = "back";			addChild(_backButton);									_playAlbumButton = new BasicButton();			_playAlbumButton.setTitle("play all");			_playAlbumButton.XPos = "CENTER";			_playAlbumButton.setClickEvent(playAllTracks);			_playAlbumButton.name = "playAlbum";			addChild(_playAlbumButton);									  			_allTracksButton = new BasicButton();			_allTracksButton.setTitle("clear all");			_allTracksButton.XPos = "RIGHT";			_allTracksButton.name = "clearAllTracks";			_allTracksButton.setClickEvent(clearAllTracks);			addChild(_allTracksButton);												loadExtras("images/ent/music/musicExtras.png", addExtras);						currentItemOption = _backButton;						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));																/*_viewPlayListButton = new BasicButton();			_viewPlayListButton.setTitle("view playlist");			_viewPlayListButton.x = 950;			_viewPlayListButton.y = 606			addChild(_viewPlayListButton);*/												this.addEventListener(Event.ADDED_TO_STAGE, onAdded,false,0,true);											}				private function onAdded(e:Event){			//trace("added");            stage.addEventListener(KeyboardEvent.KEY_UP, navUp,false,0,true);            stage.addEventListener(KeyboardEvent.KEY_DOWN, navDown,false,0,true);						ExternalInterface.addCallback("FLtrackComplete", trackEnded);			//this.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));		    drawScreen();		}						private function navUp(e:KeyboardEvent){			//trace(e.keyCode);						k = KH.convertKeyCodeToKey(e.keyCode, e.shiftKey)									switch(k)				{					case KeyType.LEFT://left arrow											trace(currentItemOption.name);						//currentItem.dispatchEvent(new InteractiveScene3DEvent(InteractiveScene3DEvent.OBJECT_OUT, currentItem));						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));						prevItemOption = getPrevOption(currentItem);						prevItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						currentItemOption = prevItemOption;						trace(currentItemOption.name);						break;					case KeyType.RIGHT://right arrow						trace(currentItemOption.name);						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));						nextItemOption = getNextOption(currentItem);						nextItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						currentItemOption = nextItemOption;						trace(currentItemOption.name);						break;											case KeyType.UP://up arrow						trace(currentItem.name);												itemIndex = Number(currentItem.extra.index);						if(itemIndex > 0){						_scroller.scroller.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_DOWN, true, false));						//_scroller.scroller.y -= Math.min(_scroller.scroller.y -_scroller.track.height/totalItems, 0);						_scroller.scroller.y = ((_scroller.track.height-_scroller.scroller.height)/totalItems)*(itemIndex-1);						_scroller.startScroll();						_scroller.scroller.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_UP, true, false));												trace("up "+_scroller.scroller.y);						trace((_scroller.track.height/totalItems)*itemIndex-1)						trace(_scroller.track.height, totalItems, itemIndex)												currentItem.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));						prevItem = getPrevItem(currentItem);						prevItem.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						currentItem = prevItem;						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));						currentItemOption = currentItem.extra.addButton;						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						trace(currentItem.name);												}																		break;											case KeyType.DOWN://down arrow						trace(currentItem.name);																		itemIndex = Number(currentItem.extra.index);						if(itemIndex < totalItems-1){						_scroller.scroller.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_DOWN, true, false));						//_scroller.scroller.y += Math.max(_scroller.track.height/totalItems, _scroller.track.height);						_scroller.scroller.y = ((_scroller.track.height-_scroller.scroller.height)/totalItems)*(itemIndex+1);						_scroller.startScroll();						_scroller.scroller.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_UP, true, false));																		trace("down "+_scroller.scroller.y);						currentItem.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));						nextItem = getNextItem(currentItem);						nextItem.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						currentItem = nextItem;						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));						currentItemOption = currentItem.extra.addButton;						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						trace(currentItem.name);												}											case KeyType.OK://select current item						//if(currentItem != previousItem){						//keyboard = true;						//trace(currentItem.name);						var optionButton = currentItemOption;						optionButton.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));						//}						break;																case KeyType.HOME://back button						closeButton.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));						break;																	case KeyType.BACK://back button						closeButton.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));						break;																					}						}						private function navDown(e:KeyboardEvent){						/*			k = KH.convertKeyCodeToKey(e.keyCode, e.shiftKey)									switch(k)				{											case KeyType.UP://up arrow						upArrow.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_DOWN, true, false));						break;											case KeyType.DOWN://down arrow						downArrow.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_DOWN, true, false));						break;																}*/						}				private function loadImage(imagePath, onImageLoaded)		{			_imageLoader = new Loader();			_imageLoader.contentLoaderInfo.addEventListener(Event.INIT, onImageLoaded);			_imageLoader.load( new URLRequest(imagePath));		}				private function loadExtras(imagePath, onExtrasLoaded)		{			_extrasLoader = new Loader();			_extrasLoader.contentLoaderInfo.addEventListener(Event.INIT, onExtrasLoaded);			_extrasLoader.load( new URLRequest(imagePath));		}						private function drawScreen(){									_playList = MovieClip(root)._playList;						_tracks = _playList.album.tracks.*;						totalItems = _tracks.length();									screen.title.x = (contentRegion.x - screen.x);												var headerFormat = new TextFormat();			headerFormat.font = "Reflex Bold";			headerFormat.kerning = true;			headerFormat.color = 0xFFFFFF;			headerFormat.size = 20;			headerFormat.align = "left";												var trackFormat = new TextFormat();			trackFormat.font = "Century Gothic";			trackFormat.kerning = true;			trackFormat.color = 0xFFFFFF;			trackFormat.size = 18;			trackFormat.align = "left";															contentMC = new MovieClip();			contentMC.y = 20;			contentMC.name = "trackHolder";			contentMC.graphics.beginFill(0x000000, 0);			contentMC.graphics.drawRect(0,0,40,650);			contentMC.graphics.endFill();									var headerMC = new MovieClip();			headerMC.x = 25;			headerMC.y = 5;			var _trackColumnLabel = new TextField();			_trackColumnLabel.height = 40;				_trackColumnLabel.text = "TRACK";				_trackColumnLabel.x = 30;				_trackColumnLabel.y = 0;				_trackColumnLabel.selectable = false; 				_trackColumnLabel.setTextFormat(headerFormat);									var _addColumnLabel = new TextField();			_addColumnLabel.height = 40;				_addColumnLabel.text = "REMOVE";				_addColumnLabel.x = 500;				_addColumnLabel.selectable = false; 				_addColumnLabel.setTextFormat(headerFormat);									var _playColumnLabel = new TextField();			_playColumnLabel.height = 40;				_playColumnLabel.text = "PLAY";				_playColumnLabel.x = 580;				_playColumnLabel.selectable = false; 				_playColumnLabel.setTextFormat(headerFormat);						var _albumColumnLabel = new TextField();			_albumColumnLabel.height = 40;				_albumColumnLabel.text = "ALBUM";				_albumColumnLabel.x = 380;				_albumColumnLabel.selectable = false; 				_albumColumnLabel.setTextFormat(headerFormat);									headerMC.addChild(_trackColumnLabel);			headerMC.addChild(_addColumnLabel);			headerMC.addChild(_playColumnLabel);						//headerMC.addChild(_albumColumnLabel);						contentRegion.addChild(headerMC);									var currentItemSet = false;			var currentItemOptionSet = false;												//trace(_tracks.length());						for (var i = 0; i < totalItems; i++){				//trace(_tracks[i].id);				var _id = _tracks[i].id;				var _albumName = _tracks[i].album;							var _trackName = _tracks[i].name;								var _thumbsrc = _tracks[i].image;				//trace(_tracks[i]);				var trackWidth:Number = 640;				var trackHeight:Number = 40;				var _trackListing:MovieClip = new MovieClip();					_trackListing.y = (50*i);					//trace(_trackListing.y)					_trackListing.x = 10;					_trackListing.name = 'trackListing_'+i;					_trackListing.buttonMode = true;					_trackListing.selected = false;					_trackListing.mouseChildren = false;					_trackListing.extra = new Object();					_trackListing.extra.thumbsrc = _thumbsrc;					_trackListing.extra.trackID = _id;					_trackListing.extra.index = i;														var _background:MovieClip = new MovieClip();					_background.graphics.lineStyle(2, 0xFFFFFF);					_background.graphics.beginFill(0xFFFFFF, 0);					_background.graphics.drawRoundRect(0,0,650,trackHeight,trackHeight,trackHeight);					_background.graphics.endFill();					_background.name = 'trackBackground';					_background.alpha = 0;				var _trackTitle = new TextField();					_trackTitle.text = (i+1)+". "+ _trackName;					_trackTitle.autoSize = TextFieldAutoSize.LEFT;					_trackTitle.embedFonts = true;					_trackTitle.x = 20;					_trackTitle.y = 5;					_trackTitle.selectable = false; 					if(_trackTitle.length > 34){						_trackTitle.replaceText(35, 1000, "...")						}										_trackTitle.setTextFormat(trackFormat);														var _albumTitle = new TextField();					//_albumTitle.text = (i+1)+". "+ _albumName;					_albumTitle.text =_albumName;					_albumTitle.autoSize = TextFieldAutoSize.LEFT;					_albumTitle.embedFonts = true;					_albumTitle.x = 370;					_albumTitle.y = 5;					_albumTitle.selectable = false; 					if(_albumTitle.length > 27){						_albumTitle.replaceText(28, 1000, "...")						}										_albumTitle.setTextFormat(trackFormat);									var _button:MovieClip = new MovieClip();					_button.graphics.lineStyle(2, 0xFFFFFF, 0);					_button.graphics.beginFill(0xFFFFFF, 0);					_button.graphics.drawRoundRect(0,0,600,trackHeight,trackHeight,trackHeight);					_button.graphics.endFill();					_button.name = 'trackButton';					_button.alpha = 0;													_trackListing.addChild(_background);				_trackListing.addChild(_trackTitle);				//_trackListing.addChild(_albumTitle);				_trackListing.addChild(_button);												var _addButton:MovieClip = new musicPlusBtn();					_addButton.x = 500;					_addButton.y = (50*i);					_addButton.name = 'addButton_'+i;										_addButton.extra = new Object();					_addButton.extra.trackId = _id;					_addButton.extra._xml = _tracks[i] as XML;										_addButton.gotoAndStop("removeTrack");																				_addButton.addEventListener(MouseEvent.CLICK, removeTrack,false,0,true);					_addButton.addEventListener(MouseEvent.MOUSE_OVER, addGlow,false,0,true);					_addButton.addEventListener(MouseEvent.MOUSE_OUT, removeGlow,false,0,true);																			var _playButton:MovieClip = new musicPlayButton();				_playButton.x = 580;				_playButton.y = (50*i);				_playButton.name = 'playButton_'+i;				_playButton.extra = new Object();				_playButton.extra.playing = false;				_playButton.extra.trackId = _id;									_trackListing.extra.playButton = _playButton;				_trackListing.extra.addButton = _addButton;									contentMC.addChild(_trackListing);				contentMC.addChild(_addButton);				contentMC.addChild(_playButton);												_trackListing.addEventListener(MouseEvent.CLICK, trackSelect,false,0,true);				_trackListing.addEventListener(MouseEvent.MOUSE_OVER, trackSelect,false,0,true);												_playButton.addEventListener(MouseEvent.CLICK, playTrack,false,0,true);				_playButton.addEventListener(MouseEvent.MOUSE_OVER, addGlow,false,0,true);				_playButton.addEventListener(MouseEvent.MOUSE_OUT, removeGlow,false,0,true);				//_trackListing.addEventListener(MouseEvent.MOUSE_UP, trackDeSelect); 								if(currentItemSet != true){				currentItem = _trackListing;				//trace(currentItem.name);				currentItemSet = true;				}				if(currentItemOptionSet != true){				currentItemOption = _addButton;				//trace(currentItemOption.name);				currentItemOptionSet = true;				}																										}						 				contentMC.addEventListener(Event.ENTER_FRAME,trackListener,false,0,true);						/*			_description.width = contentRegion.width - 100;			//_description.height = 50;			_description.text = _bodyText + "\n\n" + _cost + "\n" + _rating + "\n" + _directors + "\n" + _starring + "\n" + _runTime + "\n" + _studio;			_description.wordWrap = true;			_description.autoSize = TextFieldAutoSize.LEFT;			_description.embedFonts = true;			_description.y = 0;			_description.setTextFormat(CC_BodyFormat);*/									setContentMC(contentMC);			//loadImage(_thumbsrc, addThumb);						//dummy clip for the "Games other people liked" section			if(totalItems > 0){			currentItem.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));			currentItem.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));			currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						}					}								private function playAllTracks(e:MouseEvent){			_playAll = true;				currentItem.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));				currentItem.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));				currentItemOption = currentItem.extra.playButton;				currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));				currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));					}								private function removeTrack(e:MouseEvent):void {			var trackId = e.target.extra.trackId;			var trackXML = e.target.extra._xml;						delete _playList.album.tracks.track.(id == trackId)[0];									drawScreen();					}				private function playTrack(e:MouseEvent):void {			_mediaPlaying = true;					MovieClip(root).mediaType = "Audio";					MovieClip(root).stopMedia();						if(e.target.extra.playing == false){												var p = e.target.parent;												for (var i=0; i < totalItems;i++)						{							var playButton = p.getChildByName('playButton_'+i);								playButton.gotoAndStop(1);								playButton.extra.playing = false;						}						//trace(e.target.extra.trackId);						MovieClip(root).mediaID = e.target.extra.trackId;						MovieClip(root).launchMedia();						e.target.gotoAndStop(2);						e.target.extra.playing = true;						_currentTrack = e.target;																}else{											MovieClip(root).mediaType = "Audio";					MovieClip(root).mediaID = e.target.extra.trackId;					MovieClip(root).pauseMedia();						e.target.gotoAndStop(1);					e.target.extra.playing = false;					}											}						private function trackEnded(){						if(_playAll == true){								_currentTrack.gotoAndStop(1);				_currentTrack.extra.playing = false;				_currentTrack.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));			//if(currentItem.extra.index < totalItems){				var _currentItem;				_currentItem = getNextItem(currentItem);				_currentItem.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));				_currentItem.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));				currentItemOption = _currentItem.extra.playButton;				currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));				currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));							//}						}else{				_currentTrack.gotoAndStop(1);				_currentTrack.extra.playing = false;				_mediaPlaying = false;			}					}								private function clearAllTracks(e:MouseEvent){			for (var i = 0; i < totalItems; i++){				delete _playList.album.tracks.track;							}			drawScreen();		}								private function getNextItem(_currentItem){			var index = Number(_currentItem.extra.index);			var parentMC = _currentItem.parent;			var result;			if(index < Number(totalItems-1)){			result = parentMC.getChildByName("trackListing_"+Number(index+1));			}else{			result = parentMC.getChildByName("trackListing_0");			}			return result;						}					private function getPrevItem(_currentItem){			var index = Number(_currentItem.extra.index);			var parentMC = _currentItem.parent;			//trace(totalItems);			var result;			if(index > 0){			result = parentMC.getChildByName("trackListing_"+Number(index-1));			}else{			result = parentMC.getChildByName("trackListing_"+Number(totalItems-1));			}						return result;						}								private function getNextOption(_currentItem){				var result;								switch(currentItemOption){										case _currentItem.extra.addButton:						result = _currentItem.extra.playButton;						break;											case _currentItem.extra.playButton:						result = _backButton;						break;											case _backButton:						result = _playAlbumButton;						break;											case _playAlbumButton:						result = _allTracksButton;						break;											case _allTracksButton:						result = _currentItem.extra.addButton;						break;				}								return result;			}					private function getPrevOption(_currentItem){				var result;								switch(currentItemOption){										case _currentItem.extra.addButton:						result = _allTracksButton;						break;											case _allTracksButton:						result = _playAlbumButton;						break;											case _playAlbumButton:						result = _backButton;						break;											case _backButton:						result = _currentItem.extra.playButton						break;											case _currentItem.extra.playButton:						result = _currentItem.extra.addButton;						break;				}								return result;							}				private function goBack(e:MouseEvent){			parentMC = this.parent;			var myView = new com.brilliantblue.panasonic.IFEdemo.audioVideo.musicOnDemand.view();						//trace(this.parent.name);			myView.x = -1280;//at lest... maybe further right			myView.ID = _itemID;			parentMC.addChild(myView);			//do our tween and then add onComplete function to:			//do a softCloseClick for the current screen			Tweener.addTween(this,{x: 1280, time: 1, delay: 0.25});			Tweener.addTween(myView,{							 x: 0, 							 time: 1, 							 delay: 0.25, 							 onComplete: function(){										swapOutClose();										}, 							 onCompleteScope: this							 });			//do a new tween on the new item after we've added it					}														private function addGlow(e:MouseEvent){			e.target.filters = [glowFilter];		}				private function removeGlow(e:MouseEvent){			e.target.filters = [];		}														private function trackSelect(e:MouseEvent):void			{			var target = e.target;							var tracks = e.target.parent.numChildren;			for(var i = 0; i < tracks; i++){			var track = e.target.parent.getChildAt(i);			if(track.selected == true){				track.selected = false;			}						}			target.selected = true;			try{			this.removeChild(_musicThumb);						}catch(e:Error){							}						loadImage(target.extra.thumbsrc, addThumb);						_trackID = target.extra.trackID;									currentItem = e.target;			}						private function trackPreSelect(trackName):void			{			_trackID = _tracks[0].id;			var trackHolder = contentRegion.scrollArea.getChildByName("trackHolder");				  				//trace( trackHolder.numChildren );			var target = trackHolder.getChildByName(trackName);									var tracks = target.parent.numChildren;			for(var i = 0; i < tracks; i++){			var track = target.parent.getChildAt(i);			if(track.selected == true){				track.selected = false;			}						}			target.selected = true;			try{			this.removeChild(_musicThumb);						}catch(e:Error){							}						loadImage(target.extra.thumbsrc, addThumb);						}					private function trackListener(e:Event):void{			var tracks = e.target.numChildren;			for(var i = 0; i < tracks; i++){			var track = e.target.getChildAt(i);			//trace(track.name);			var background = track.getChildByName("trackBackground");			//var playButton = e.target.getChildByName("playButton_"+i);			//trace(track.selected);			if(track.selected == true){				Tweener.addTween(background,{alpha:1,time:0.5, transition:"easeOutBack"});							}else{				Tweener.addTween(background,{alpha:0,time:0.5, transition:"easeOutBack"});							}						/*			if(playButton.playing == true){				Tweener.addTween(background,{alpha:1,time:0.5, transition:"easeOutBack"});			}else{				Tweener.addTween(background,{alpha:0,time:0.5, transition:"easeOutBack"});							}*/															}								}								private function addThumb (e:Event){			_musicThumb = new MovieClip();			try{			_musicThumb.addChild(_imageLoader.content);			}catch(e:Error){			}			_musicThumb.x = 123;			_musicThumb.y = 100;			var tempWidth = _musicThumb.width;			var tempHeight = _musicThumb.height			_musicThumb.height = 240;			var tempRatio =  _musicThumb.height / tempHeight;			_musicThumb.width = _musicThumb.width * tempRatio;			this.addChild(_musicThumb);		}				private function addExtras (e:Event){			_musicExtras = new MovieClip();			_musicExtras.addChild(_extrasLoader.content);			_musicExtras.x = 100;			_musicExtras.y = 340;			this.addChild(_musicExtras);		}				override protected function screenShutDown(){			if(_mediaPlaying == true){					MovieClip(root).mediaType = "Audio";					MovieClip(root).stopMedia();				}			stage.removeEventListener(KeyboardEvent.KEY_UP, navUp);			stage.removeEventListener(KeyboardEvent.KEY_DOWN, navDown);		}							}		}