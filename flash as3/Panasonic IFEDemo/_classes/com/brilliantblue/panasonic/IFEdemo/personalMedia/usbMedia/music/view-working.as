package com.brilliantblue.panasonic.IFEdemo.personalMedia.usbMedia.music{    import br.com.stimuli.loading.BulkLoader;    import br.com.stimuli.loading.BulkProgressEvent;	import flash.display.*;	import flash.events.*;	import flash.text.*	import flash.utils.*	import flash.external.*	import flash.net.*;	import caurina.transitions.*;		import com.brilliantblue.panasonic.IFEdemo.view;	import com.brilliantblue.panasonic.IFEdemo.common.screen.*;	import com.brilliantblue.panasonic.IFEdemo.common.buttons.*;	import com.brilliantblue.panasonic.IFEdemo.common.key.*;	import com.brilliantblue.panasonic.IFEdemo.common.files.*;			public class view extends com.brilliantblue.panasonic.IFEdemo.view	{				public var tabInfoMC:MovieClip;		public var myTextField:TextField;		public var leftNav:Array;		private var imageLoader:BulkLoader;		private var xmlLoader:URLLoader;		private var _filesData:XML;		private var _files:XMLList;		private var _photos:XMLList;		private var _fullScreenTarget:String = '';		private var _totalPhotos:Number;		private var viewBtn:MovieClip;		public var usbTimer:Timer;		public var messageFormat:TextFormat;				public function view () 		{			setLayout("2column");			setScreenTitle("USB MEDIA - Music");			adjustScreen();									this.addEventListener(Event.ADDED_TO_STAGE, onAdded,false,0,true);											ExternalInterface.addCallback("FLsetUSBMediaDirectory",function(){		ExternalInterface.call("myAlert","loadContent('tmp/output.xml');");		loadContent("tmp/output.xml");				}			);					}								private function onAdded(e:Event){			//trace("added");            stage.addEventListener(KeyboardEvent.KEY_UP, navUp,false,0,true);            stage.addEventListener(KeyboardEvent.KEY_DOWN, navDown,false,0,true);						loadUSBMedia();		}								private function navUp(e:KeyboardEvent){			//trace(e.keyCode);			var KH = new KeyHandler();			var k = KH.convertKeyCodeToKey(e.keyCode, e.shiftKey)			/*			var upArrow = contentRegion.sb.upArrow;			var downArrow = contentRegion.sb.downArrow;*/						switch(k)				{					/*case KeyType.LEFT://left arrow											trace(currentItemOption.name);						//currentItem.dispatchEvent(new InteractiveScene3DEvent(InteractiveScene3DEvent.OBJECT_OUT, currentItem));						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));						prevItemOption = getPrevOption(currentItem);						prevItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						currentItemOption = prevItemOption;						trace(currentItemOption.name);						break;					case KeyType.RIGHT://right arrow						trace(currentItemOption.name);						currentItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OUT, true, false));						nextItemOption = getNextOption(currentItem);						nextItemOption.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_OVER, true, false));						currentItemOption = nextItemOption;						trace(currentItemOption.name);						break;											case KeyType.UP://up arrow						upArrow.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_UP, true, false));						break;											case KeyType.DOWN://down arrow						downArrow.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_UP, true, false));						break;*/											/*case KeyType.OK://select current item						//if(currentItem != previousItem){						//keyboard = true;						//trace(currentItem.name);						var optionButton = currentItemOption;						optionButton.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));						//}						break;*/																case KeyType.HOME://back button						closeButton.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));						break;											case KeyType.BACK://back button						closeButton.dispatchEvent(new MouseEvent(MouseEvent.CLICK, true, false));						break;																					}						}						private function navDown(e:KeyboardEvent){						var KH = new KeyHandler();			var k = KH.convertKeyCodeToKey(e.keyCode, e.shiftKey)						var upArrow = contentRegion.sb.upArrow;			var downArrow = contentRegion.sb.downArrow;						switch(k)				{											/*case KeyType.UP://up arrow						upArrow.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_DOWN, true, false));						break;											case KeyType.DOWN://down arrow						downArrow.dispatchEvent(new MouseEvent(MouseEvent.MOUSE_DOWN, true, false));						break;						*/										}						}						override protected function screenShutDown(){						stage.removeEventListener(KeyboardEvent.KEY_UP, navUp);			stage.removeEventListener(KeyboardEvent.KEY_DOWN, navDown);		}								private function drawScreen(){						var totalFiles = new TextField();				totalFiles.text = "Total Photos: "+_totalPhotos.toString();				totalFiles.x = 115;				totalFiles.y = 180;				totalFiles.autoSize = TextFieldAutoSize.LEFT;				totalFiles.embedFonts = true;				totalFiles.selectable = false;				totalFiles.setTextFormat(LC_SubHeadFormat);			addChild(totalFiles);											viewBtn = new BasicButton();				viewBtn.setTitle("VIEW FULL SCREEN");				viewBtn.x = 900;				viewBtn.y = 605;				viewBtn.name = "viewBtn";				viewBtn.setClickEvent(fullScreen);							addChild(viewBtn);									leftNav = new Array("THUMBNAIL", "LIST", "SLIDESHOW");						for(var i = 0; i < leftNav.length; i++){								var leftNavBtn = new SelectButton();				leftNavBtn.setTitle(leftNav[i]);				leftNavBtn.x = 115;				leftNavBtn.y = 240+(i*80);				leftNavBtn.buttonWidth = 250;				leftNavBtn.name = "leftNavBtn_"+i;				leftNavBtn.setClickEvent(this[leftNav[i]+"_CLICK"]);								addChild(leftNavBtn);				}						/*			var thumbnailBtn = new SelectButton();				thumbnailBtn.setTitle("THUMBNAIL");				thumbnailBtn.x = 120;				thumbnailBtn.y = 335;				thumbnailBtn.buttonWidth = 250;				thumbnailBtn.name = "thumbnailBtn";				thumbnailBtn.setClickEvent(setThumbView);							addChild(thumbnailBtn);												var listBtn = new SelectButton();				listBtn.setTitle("LIST");				listBtn.x = 120;				listBtn.y = 415;				listBtn.buttonWidth = 250;				listBtn.name = "listBtn";				listBtn.setClickEvent(setListView);							addChild(listBtn);												var slideShowBtn = new SelectButton();				slideShowBtn.setTitle("SLIDESHOW");				slideShowBtn.x = 120;				slideShowBtn.y = 495;				slideShowBtn.buttonWidth = 250;				slideShowBtn.name = "slideShowBtn";				slideShowBtn.setClickEvent(setSlideView);							addChild(slideShowBtn);													tabInfoMC = new TabInfoList;				tabInfoMC.x = 120;				tabInfoMC.y = 200;						addChild(tabInfoMC);			*/												startMenu();					}								private function startMenu(){						loadPhotoList();					var firstItem = getChildByName("leftNavBtn_1");			//setContentMC(personalMediaThumb);			for(var i=0; i < leftNav.length;i++)			{				var selectButton = getChildByName("leftNavBtn_"+i);					selectButton.unSelectButton();			}			firstItem.selectButton();					}				private function LIST_CLICK(e:MouseEvent){			//setContentMC(personalMediaList);						loadPhotoList();						for(var i=0; i < leftNav.length;i++)			{				var selectButton = getChildByName("leftNavBtn_"+i);					selectButton.unSelectButton();			}			e.target.selectButton();					}				private function SLIDESHOW_CLICK(e:MouseEvent){			//setContentMC(personalMediaSlide);						loadPhotoSlideShow();						for(var i=0; i < leftNav.length;i++)			{				var selectButton = getChildByName("leftNavBtn_"+i);					selectButton.unSelectButton();			}			e.target.selectButton();		}						private function THUMBNAIL_CLICK(e:MouseEvent){						loadPhotoThumbnails();						//setContentMC(personalMediaThumb);			for(var i=0; i < leftNav.length;i++)			{				var selectButton = getChildByName("leftNavBtn_"+i);					selectButton.unSelectButton();			}			e.target.selectButton();		}						private function fullScreen(e:MouseEvent){			if(_fullScreenTarget != ''){			var _imageLoader:Loader;			var _fullScreenMC:MovieClip = new MovieClip();			_fullScreenMC.name = "fullScreenMC";			_fullScreenMC.buttonMode = true;			_fullScreenMC.graphics.beginFill(0x000000, 0.8);			_fullScreenMC.graphics.drawRect(0,0,1280,800);			_fullScreenMC.graphics.endFill();						_fullScreenMC.addEventListener(MouseEvent.CLICK, removeFullScreen,false,0,true);			var _path:String = _fullScreenTarget;						loadImage(_path, attachMC);										function loadImage(imagePath, onImageLoaded)				{					_imageLoader = new Loader();					_imageLoader.contentLoaderInfo.addEventListener(Event.INIT, onImageLoaded,false,0,true);					_imageLoader.load( new URLRequest(imagePath));				}								function attachMC(e:Event)				{					var image = _imageLoader.content;										/*if(image.width > 1280 && image.height > 800){						if(((1280/image.width) * image.height) < 800){					image.width = (1280/image.width) * image.width;					image.height = (1280/image.width) * image.height;						}else{					image.height = (800/image.height) * image.height;					image.width = (800/image.height) * image.width;						}					}else if (image.width > 1280 && image.height <= 800){					image.width = (1280/image.width) * image.width;					image.height = (1280/image.width) * image.height;											}else if (image.height > 800 && image.width <= 1280){					image.height = (800/image.height) * image.height;					image.width = (800/image.height) * image.width;											}*/										if (image.width > 1280){						image.width = 1280;						image.scaleY = image.scaleX;						if(image.height > 800){						image.height = 800;						image.scaleX = image.scaleY;						}					}																				image.x = 640 - (image.width/2);					image.y = 400 - (image.height/2);					_fullScreenMC.addChild(image);										addChild(_fullScreenMC);				}								}else{				return;			}		}//end fullScreen				private function removeFullScreen(e:MouseEvent){			var removeMC = getChildByName("fullScreenMC")			removeMC.removeEventListener(MouseEvent.CLICK, removeFullScreen);			removeMC.removeChildAt(0);			removeChild(removeMC);		}						private function loadPhotoList(){						var subMenuMC = new MovieClip();						for (var i = 0; i < _totalPhotos; i++){							var filenameArray:Array = _photos[i].@path.split("/");			var fileName = filenameArray[filenameArray.length-1].toLowerCase();			//var fileSize = _photos[i].@fileSize;			var filePath = _photos[i].@path;						var subNavButton:MovieClip = new MenuButton();			//selectButton2.name = 'selectButton1';						subNavButton.setTitle(fileName);			if (subNavButton.btn_label.text > 15){				subNavButton.btn_label.replaceText(15, 2000, "...")			}			subNavButton.setClickEvent(setFullScreen);			subNavButton.x = 0;			subNavButton.y = 0+50*i;			subNavButton.buttonWidth = 650;			subNavButton.name = "subNavButton_"+i;			subNavButton.extra.path = filePath;			//trace(navButton.name)						subMenuMC.addChild(subNavButton);											}						setContentMC(subMenuMC);					}						private function loadPhotoSlideShow(){								 	var item:Number = 0;						BulkLoader.removeAllLoaders();						imageLoader = new BulkLoader("Thumbnail Loader");						var subMenuMC = new MovieClip();									// add event listeners for the loader itself :			// event fired when all items have been loaded			imageLoader.addEventListener(BulkLoader.COMPLETE, onCompleteHandler,false,0,true);			// event fired when loading progress has been made:			//bulkLoader.addEventListener(BulkLoader.PROGRESS, _onProgressHandler);					// start loading all items						for (var i = 0; i < _totalPhotos; i++){						var filePath = _photos[i].@path;			    		var image : URLRequest = new URLRequest(filePath);			imageLoader.add(image, {id:"image"+i});							 			}									imageLoader.start();						function onCompleteHandler(e:Event){										for (var i = 0; i < _totalPhotos; i++){										var _thumbButtonHolder:MovieClip = new MovieClip();			_thumbButtonHolder.name = "thumbButtonHolder_"+i;											var image : Bitmap = imageLoader.getBitmap("image"+i);						if (image.width > 400){				image.width = 400;				image.scaleY = image.scaleX;				if(image.height > 400){				image.height = 400;				image.scaleX = image.scaleY;				}								image.x = 200 - image.width/2;				image.y = 200 - image.height/2;			}						_thumbButtonHolder.addChild(image);						var _thumbButtonMask = new MovieClip();			_thumbButtonMask.graphics.beginFill(0x000000, 1);			_thumbButtonMask.graphics.drawRect(0,0,400,400);			_thumbButtonMask.graphics.endFill();			_thumbButtonMask.name="thumbButtonMask_"+i;			_thumbButtonHolder.addChild(_thumbButtonMask);			_thumbButtonHolder.alpha = 0;						image.mask = _thumbButtonMask;			subMenuMC.addChild(_thumbButtonHolder);						 				//trace("name: "+_thumbButton.name+" x: "+_thumbButton.x+" y: "+_thumbButton.y)				/*				if(XCount >= 2){					XCount = 0;					YCount++;				}else{				XCount++				}			*/													}											setContentMC(subMenuMC);									showItem();						}										function showItem(){										if(item < _totalPhotos) {					var itemMC = subMenuMC.getChildByName("thumbButtonHolder_"+item);					itemMC.alpha = 1;					trace(itemMC.name)					var itemMC2						if(item < Number(_totalPhotos - 1)){						   itemMC2 = subMenuMC.getChildByName("thumbButtonHolder_"+(item+1));						   trace(itemMC2.name)						}else{						   itemMC2 = subMenuMC.getChildByName("thumbButtonHolder_0");						   trace(itemMC2.name)						}					//itemMC.alpha = 0;					//trace(itemMC.name);										Tweener.addTween(itemMC, {alpha:0, time:2, delay: 4, onComplete: showItem});					Tweener.addTween(itemMC2, {alpha:1, time:2, delay: 4});					item++					}else{						item = 0;						showItem();				}//end showitem												}														}						private function loadPhotoThumbnails(){			BulkLoader.removeAllLoaders();						imageLoader = new BulkLoader("Thumbnail Loader");						var subMenuMC = new MovieClip();						var XCount = 0;			var YCount = 0;						// add event listeners for the loader itself :			// event fired when all items have been loaded			imageLoader.addEventListener(BulkLoader.COMPLETE, onCompleteHandler,false,0,true);			// event fired when loading progress has been made:			//bulkLoader.addEventListener(BulkLoader.PROGRESS, _onProgressHandler);					// start loading all items						for (var i = 0; i < _totalPhotos; i++){						var filePath = _photos[i].@path;			    		var image : URLRequest = new URLRequest(filePath);			imageLoader.add(image, {id:"image"+i});							 							}									imageLoader.start();						function onCompleteHandler(e:Event){							            var XCount : int = 0;            var YCount : int = 0;						for (var i = 0; i < _totalPhotos; i++){							var filePath = _photos[i].@path;						var _thumbButton:MovieClip = new MovieClip();			_thumbButton.name = "thumbButton_"+i;			_thumbButton.graphics.beginFill(0xFFFFFF, 1);			_thumbButton.graphics.drawRect(0,0,210,210);			_thumbButton.graphics.endFill();			_thumbButton.buttonMode = true;			_thumbButton.alpha = 0;			_thumbButton.extra = new Object();			_thumbButton.extra.path = filePath;			_thumbButton.x = 215*XCount;			_thumbButton.y = 215*YCount;			_thumbButton.addEventListener(MouseEvent.CLICK, setFullScreenThumb,false,0,true);						var _thumbButtonHolder:MovieClip = new MovieClip();			_thumbButtonHolder.name = "thumbButtonHolder_"+i;			_thumbButtonHolder.x = 215*XCount;			_thumbButtonHolder.y = 215*YCount;					var _thumbButtonBackground = new MovieClip();			_thumbButtonBackground.graphics.beginFill(0xFFFFFF, 1);			_thumbButtonBackground.graphics.drawRect(0,0,210,210);			_thumbButtonBackground.graphics.endFill();			_thumbButtonBackground.alpha = 0.6;			_thumbButtonBackground.x = 215*XCount;			_thumbButtonBackground.y = 215*YCount;									var image : Bitmap = imageLoader.getBitmap("image"+i);						if (image.width > 300){				image.width = 300;				image.scaleY = image.scaleX;				image.x = 105 - image.width/2;				image.y = 105 - image.height/2;			}						_thumbButtonHolder.addChild(image);						var _thumbButtonMask = new MovieClip();			_thumbButtonMask.graphics.beginFill(0x000000, 1);			_thumbButtonMask.graphics.drawRect(2,2,206,206);			_thumbButtonMask.graphics.endFill();			_thumbButtonMask.name="thumbButtonMask_"+i;			_thumbButtonHolder.addChild(_thumbButtonMask);						image.mask = _thumbButtonMask;									subMenuMC.addChild(_thumbButtonBackground);			subMenuMC.addChild(_thumbButtonHolder);			subMenuMC.addChild(_thumbButton);						 				//trace("name: "+_thumbButton.name+" x: "+_thumbButton.x+" y: "+_thumbButton.y)								if(XCount >= 2){					XCount = 0;					YCount++;				}else{				XCount++				}																}											setContentMC(subMenuMC);						}								}								private function setFullScreen(e:MouseEvent){			var p = e.target.parent;			for(var i=0; i < _totalPhotos;i++)			{				var selectButton = p.getChildByName("subNavButton_"+i);					selectButton.unSelectButton();			}			e.target.selectButton();						_fullScreenTarget = e.target.extra.path;					}						private function setFullScreenThumb(e:MouseEvent){			trace(e.target.name);			var p = e.target.parent;			var thumbButton;						for(var i=0; i < _totalPhotos;i++)			{				thumbButton = p.getChildByName("thumbButton_"+i);				//background = thumbButton.getChildByName("background");				thumbButton.alpha = 0;			}			e.target.alpha = 0.2;			_fullScreenTarget = e.target.extra.path;					}											private function loadUSBMedia(){						usbTimer = new Timer(1000,0)			usbTimer.addEventListener(TimerEvent.TIMER, getUSBXML,false,0,true);			usbTimer.start();					}								private function getUSBXML(e:TimerEvent)		{			var usbStatus;			var usbDirectory;			trace("USB Timer...");			//myTextField.text = "USB Timer...";			//myTextField.setTextFormat(messageFormat);			usbStatus = MovieClip(root).getUSBStatus();			//loadUSBDirectory(usbDirectory);//debug positioning for flash			//ExternalInterface.call("myAlert","First "+ usbStatus);			if(usbStatus != undefined){				//myTextField.appendText(myAux);				if(usbStatus != ''){									trace("USB Status...");				//myTextField.appendText("YEah! "+ myAux.toString());				usbDirectory = MovieClip(root).getUSBDirectory(usbStatus);				}			}else{			loadContent("tmp/output.xml");								}								}														private function loadContent(xmlPath) 		{				xmlLoader = new URLLoader();				xmlLoader.addEventListener(Event.COMPLETE,onLoadXML);             	xmlLoader.addEventListener(IOErrorEvent.IO_ERROR, errorHandler);				xmlLoader.load(new URLRequest(xmlPath));							usbTimer.stop();			usbTimer.removeEventListener(TimerEvent.TIMER, getUSBXML);			}					private function onLoadXML(e:Event):void 		{							var image:RegExp = /^([a-zA-Z].*|[1-9].*)\.(((j|J)(p|P)(g|G))|((p|P)(n|N)(g|G))|((g|G)(i|I)(f|F))|((j|J)(p|P)(e|E)(g|G)))$/;						_filesData = new XML(e.target.data);			_photos = _filesData.file.(image["test"]( @path ) );						_totalPhotos = _photos.length();						trace("FILTERED "+_photos);								drawScreen();							}						private function errorHandler(e:IOErrorEvent)		{							//ExternalInterface.call("myAlert","Had problem loading the XML File.");			//myTextField.appendText("Had problem loading the XML File.\n");			//myTextField.setTextFormat(messageFormat);						//loadContent("tmp/output.xml");									}																}		}